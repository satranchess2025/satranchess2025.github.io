(function(){"use strict";const PIECE_THEME_URL="https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",SAN_CORE_REGEX=/^([O0]-[O0](-[O0])?[+#]?|[KQRBN]?[a-h]?[1-8]?x?[a-h][1-8](=[QRBN])?[+#]?|[a-h][1-8](=[QRBN])?[+#]?)$/,RESULT_REGEX=/^(1-0|0-1|1\/2-1\/2|½-½|\*)$/,MOVE_NUMBER_REGEX=/^(\d+)(\.+)$/,EVAL_TOKEN=/^[\+\-=∞±]+$/,NBSP="\u00A0",NAG_MAP={1:"!",2:"?",3:"‼",4:"⁇",5:"⁉",6:"⁈",13:"→",14:"↑",15:"⇆",16:"⇄",17:"⟂",18:"∞",19:"⟳",20:"⟲",36:"⩲",37:"⩱",38:"±",39:"∓",40:"+=",41:"=+",42:"±",43:"∓",44:"⨀",45:"⨁"};let diagramCounter=0;function ensureDeps(){if(typeof Chess=="undefined"){console.warn("pgn.js: chess.js missing");return!1}return!0}function normalizeResult(t){return t?t.replace(/1\/2-1\/2/g,"½-½"):""}function extractYear(t){if(!t)return"";let e=t.split(".");return/^\d{4}$/.test(e[0])?e[0]:""}function flipName(t){if(!t)return"";let e=t.indexOf(",");return e==-1?t.trim():t.substring(e+1).trim()+" "+t.substring(0,e).trim()}function appendText(t,e){e&&t.appendChild(document.createTextNode(e))}function createDiagram(t,e){if(typeof Chessboard=="undefined"){console.warn("pgn.js: chessboard.js missing");return}let n="pgn-diagram-"+diagramCounter++,i=document.createElement("div");i.className="pgn-diagram",i.id=n,i.style.width="340px",i.style.maxWidth="100%",t.appendChild(i),setTimeout(()=>{let t=document.getElementById(n);t&&Chessboard(t,{position:e,draggable:!1,pieceTheme:PIECE_THEME_URL})},0)}function makeCastlingUnbreakable(t){return t.replace(/0-0-0|O-O-O/g,e=>e[0]+"\u2011"+e[2]+"\u2011"+e[4]).replace(/0-0|O-O/g,e=>e[0]+"\u2011"+e[2])}class PGNGameView{constructor(t){this.sourceEl=t,this.wrapper=document.createElement("div"),this.wrapper.className="pgn-blog-block",this.lastLiteralToken=null,this.build(),this.applyFigurines()}static isSANCore(t){return SAN_CORE_REGEX.test(t)}static split(t){let e=t.split(/\r?\n/),n=[],i=[],s=!0;for(let r of e){let t=r.trim();s&&t.startsWith("[")&&t.endsWith("]")?n.push(r):s&&t==""?s=!1:(s=!1,i.push(r))}return{headers:n,moveText:i.join(" ").replace(/\s+/g," ").trim()}}build(){let t=this.sourceEl.textContent.trim(),{headers:e,moveText:n}=PGNGameView.split(t),i=(e.length?e.join("\n")+"\n\n":"")+n,s=new Chess;s.load_pgn(i,{sloppy:!0});let r=s.header(),o=normalizeResult(r.Result||""),a=/(1-0|0-1|1\/2-1\/2|½-½|\*)\s*$/;let l=a.test(n)?n:n+(o?" "+o:"");this.header(r),this.parse(l),this.sourceEl.replaceWith(this.wrapper)}header(t){let e=(t.WhiteTitle?t.WhiteTitle+" ":"")+flipName(t.White||"")+(t.WhiteElo?" ("+t.WhiteElo+")":""),n=(t.BlackTitle?t.BlackTitle+" ":"")+flipName(t.Black||"")+(t.BlackElo?" ("+t.BlackElo+")":""),i=extractYear(t.Date),s=(t.Event||"")+(i?", "+i:""),r=document.createElement("h3");r.appendChild(document.createTextNode(`${e} – ${n}`)),r.appendChild(document.createElement("br")),r.appendChild(document.createTextNode(s)),this.wrapper.appendChild(r)}ensure(t,e){if(!t.container){let n=document.createElement("p");n.className=e,this.wrapper.appendChild(n),t.container=n}}handleSAN(t,e){let n=t.replace(/[^a-hKQRBN0-9=O0-]+$/g,"").replace(/0/g,"O");if(!PGNGameView.isSANCore(n))return appendText(e.container,t+" "),null;let i=e.baseHistoryLen||0,s=e.chess.history().length,r=i+s,o=r%2==0,a=Math.floor(r/2)+1;e.type=="main"?o?appendText(e.container,a+"."+NBSP):e.lastWasInterrupt&&appendText(e.container,a+"..."+NBSP):o?appendText(e.container,a+"."+NBSP):e.lastWasInterrupt&&appendText(e.container,a+"..."+NBSP),e.prevFen=e.chess.fen(),e.prevHistoryLen=r;let l=e.chess.move(n,{sloppy:!0});if(!l)return appendText(e.container,t+" "),null;e.lastWasInterrupt=!1;let h=document.createElement("span");return h.className="pgn-move sticky-move",h.dataset.fen=e.chess.fen(),h.textContent=makeCastlingUnbreakable(t)+" ",e.container.appendChild(h),h}parseComment(t,e,n){let i=e;for(;i<t.length&&t[i]!="}";)i++;let s=t.substring(e,i).trim();t[i]=="}"&&i++;if(/%\s*eval|%\s*clk/.test(s))return i;if(n.type=="main"){let j=i;for(;j<t.length&&/\s/.test(t[j]);)j++;let u="";for(;j<t.length&&!/\s/.test(t[j])&&!"(){}".includes(t[j]);)u+=t[j++];RESULT_REGEX.test(u)&&(s=s.replace(/(1-0|0-1|1\/2-1\/2|½-½|\*)\s*$/,"").trim())}let r=s.split("[D]");for(let o=0;o<r.length;o++){let a=r[o].trim();if(n.type=="variation")this.ensure(n,"pgn-variation"),a&&appendText(n.container," "+a);else{if(a){let p=document.createElement("p");p.className="pgn-comment",appendText(p,a),this.wrapper.appendChild(p)}n.container=null}o<r.length-1&&createDiagram(this.wrapper,n.chess.fen())}return n.lastWasInterrupt=!0,this.lastLiteralToken=null,i}parse(t){let e=new Chess,n={type:"main",chess:e,container:null,parent:null,lastWasInterrupt:!1,prevFen:e.fen(),prevHistoryLen:0,baseHistoryLen:null},i=0;for(;i<t.length;){let e=t[i];if(/\s/.test(e)){for(;i<t.length&&/\s/.test(t[i]);)i++;this.ensure(n,n.type=="main"?"pgn-mainline":"pgn-variation"),appendText(n.container," ");continue}if(e=="("){i++;let e=n.prevFen||n.chess.fen(),s=typeof n.prevHistoryLen=="number"?n.prevHistoryLen:n.chess.history().length;n={type:"variation",chess:new Chess(e),container:null,parent:n,lastWasInterrupt:!0,prevFen:e,prevHistoryLen:s,baseHistoryLen:s},this.ensure(n,"pgn-variation");continue}if(e==")"){i++,n.parent&&(n=n.parent,n.lastWasInterrupt=!0,n.container=null);continue}if(e=="{"){i=this.parseComment(t,i+1,n);continue}let s=i;for(;i<t.length&&!/\s/.test(t[i])&&!"(){}".includes(t[i]);)i++;let r=t.substring(s,i);if(!r)continue;if(r=="[D]"){createDiagram(this.wrapper,n.chess.fen()),n.lastWasInterrupt=!0,n.container=null;continue}if(RESULT_REGEX.test(r)){this.ensure(n,n.type=="main"?"pgn-mainline":"pgn-variation"),appendText(n.container,r+" ");continue}if(MOVE_NUMBER_REGEX.test(r))continue;let o=r.replace(/[^a-hKQRBN0-9=O0-]+$/g,"").replace(/0/g,"O"),a=PGNGameView.isSANCore(o);if(!a){if(r[0]=="$"){let t=Number(r.substring(1));NAG_MAP[t]&&(this.ensure(n,n.type=="main"?"pgn-mainline":"pgn-variation"),appendText(n.container,NAG_MAP[t]+" "));continue}let t=/[A-Za-zÇĞİÖŞÜçğıöşü]/.test(r);if(EVAL_TOKEN.test(r))continue;if(t){if(n.type=="variation")this.ensure(n,"pgn-variation"),appendText(n.container," "+r);else{let t=document.createElement("p");t.className="pgn-comment",appendText(t,r),this.wrapper.appendChild(t),n.container=null,n.lastWasInterrupt=!1}}else this.ensure(n,n.type=="main"?"pgn-mainline":"pgn-variation"),appendText(n.container,r+" ");continue}this.ensure(n,n.type=="main"?"pgn-mainline":"pgn-variation");let l=this.handleSAN(r,n);l||appendText(n.container,makeCastlingUnbreakable(r)+" ")}}applyFigurines(){let t={K:"♔",Q:"♕",R:"♖",B:"♗",N:"♘"};this.wrapper.querySelectorAll(".pgn-move").forEach(e=>{let n=e.textContent.match(/^([KQRBN])(.+?)(\s*)$/);n&&(e.textContent=t[n[1]]+n[2]+(n[3]||""))})}}class PGNRenderer{static renderAll(t){(t||document).querySelectorAll("pgn").forEach(t=>new PGNGameView(t))}static init(){ensureDeps()&&(PGNRenderer.renderAll(document),window.PGNRenderer={run(t){PGNRenderer.renderAll(t||document.body)}})}}
document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>PGNRenderer.init()):PGNRenderer.init();
})();
