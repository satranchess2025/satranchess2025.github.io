(function(){"use strict";const PIECE_THEME_URL="https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png";const SAN_CORE_REGEX=/^([O0]-[O0](-[O0])?[+#]?|[KQRBN]?[a-h]?[1-8]?x?[a-h][1-8](=[QRBN])?[+#]?|[a-h][1-8](=[QRBN])?[+#]?)$/;const RESULT_REGEX=/^(1-0|0-1|1\/2-1\/2|½-½|\*)$/;const MOVE_NUMBER_REGEX=/^(\d+)(\.+)$/;const EVAL_TOKEN=/^[\+\-=∞±]+$/;const NBSP="\u00A0";let diagramCounter=0;function ensureDeps(){if(typeof Chess==="undefined"){console.warn("pgn.js: chess.js missing");return false}return true}function normalizeResult(s){return s?s.replace(/1\/2-1\/2/g,"½-½"):""}function extractYear(d){if(!d)return"";let p=d.split(".");return/^\d{4}$/.test(p[0])?p[0]:""}function flipName(name){if(!name)return"";let i=name.indexOf(",");return i===-1?name.trim():name.substring(i+1).trim()+" "+name.substring(0,i).trim()}function appendText(el,txt){if(txt)el.appendChild(document.createTextNode(txt))}function createDiagram(wrapper,fen){if(typeof Chessboard==="undefined"){console.warn("pgn.js: chessboard.js missing");return}let id="pgn-diagram-"+diagramCounter++;let div=document.createElement("div");div.className="pgn-diagram";div.id=id;div.style.width="340px";div.style.maxWidth="100%";wrapper.appendChild(div);setTimeout(()=>{let t=document.getElementById(id);if(t)Chessboard(t,{position:fen,draggable:false,pieceTheme:PIECE_THEME_URL})},0)}class PGNGameView{constructor(el){this.sourceEl=el;this.wrapper=document.createElement("div");this.wrapper.className="pgn-blog-block";this.lastLiteralToken=null;this.lastWasMove=false;this.build();this.applyFigurines()}static isSANCore(tok){return SAN_CORE_REGEX.test(tok)}static split(raw){let lines=raw.split(/\r?\n/);let headers=[],moves=[];let inHeader=true;for(let line of lines){let t=line.trim();if(inHeader&&t.startsWith("[")&&t.endsWith("]"))headers.push(line);else if(inHeader&&t==="")inHeader=false;else{inHeader=false;moves.push(line)}}return{headers,moveText:moves.join(" ").replace(/\s+/g," ").trim()}}build(){let raw=this.sourceEl.textContent.trim();let{headers,moveText}=PGNGameView.split(raw);let full=(headers.length?headers.join("\n")+"\n\n":"")+moveText;let game=new Chess();game.load_pgn(full,{sloppy:true});let h=game.header();let result=normalizeResult(h.Result||"");this.header(h);this.parse(moveText+(result?" "+result:""));this.sourceEl.replaceWith(this.wrapper)}header(h){let white=(h.WhiteTitle?h.WhiteTitle+" ":"")+flipName(h.White||"")+(h.WhiteElo?" ("+h.WhiteElo+")":"");let black=(h.BlackTitle?h.BlackTitle+" ":"")+flipName(h.Black||"")+(h.BlackElo?" ("+h.BlackElo+")":"");let year=extractYear(h.Date);let evt=(h.Event||"")+(year?", "+year:"");let H=document.createElement("h3");H.appendChild(document.createTextNode(`${white} – ${black}`));H.appendChild(document.createElement("br"));H.appendChild(document.createTextNode(evt));this.wrapper.appendChild(H)}ensure(ctx,cls){if(!ctx.container){let p=document.createElement("p");p.className=cls;this.wrapper.appendChild(p);ctx.container=p}}handleSAN(tok,ctx){let core=tok.replace(/[^a-hKQRBN0-9=O0-]+$/g,"").replace(/0/g,"O");if(!PGNGameView.isSANCore(core)){appendText(ctx.container,tok+" ");this.lastWasMove=false;return null}let base=ctx.baseHistoryLen||0;let before=ctx.chess.history().length;let ply=base+before;let white=ply%2===0;let num=Math.floor(ply/2)+1;if(ctx.type==="main"){if(white)appendText(ctx.container,num+"."+NBSP);else if(ctx.lastWasInterrupt)appendText(ctx.container,num+"..."+NBSP)}else{if(white)appendText(ctx.container,num+"."+NBSP);else if(ctx.lastWasInterrupt)appendText(ctx.container,num+"..."+NBSP)}ctx.prevFen=ctx.chess.fen();ctx.prevHistoryLen=ply;let mv=ctx.chess.move(core,{sloppy:true});if(!mv){appendText(ctx.container,tok+" ");this.lastWasMove=false;return null}ctx.lastWasInterrupt=false;this.lastLiteralToken=null;this.lastWasMove=true;let span=document.createElement("span");span.className="pgn-move sticky-move";span.dataset.fen=ctx.chess.fen();span.textContent=tok+" ";ctx.container.appendChild(span);return span}parseComment(text,pos,ctx){let i=pos;while(i<text.length&&text[i]!=="}")i++;let content=text.substring(pos,i).trim();if(text[i]==="}")i++;let parts=content.split("[D]");for(let p=0;p<parts.length;p++){let t=parts[p].trim();if(ctx.type==="variation"){this.ensure(ctx,"pgn-variation");if(t)appendText(ctx.container," "+t)}else{if(t){let P=document.createElement("p");P.className="pgn-comment";appendText(P,t);this.wrapper.appendChild(P)}ctx.container=null}if(p<parts.length-1)createDiagram(this.wrapper,ctx.chess.fen())}ctx.lastWasInterrupt=true;this.lastLiteralToken=null;this.lastWasMove=false;return i}parse(text){let main=new Chess();let ctx={type:"main",chess:main,container:null,parent:null,lastWasInterrupt:false,prevFen:main.fen(),prevHistoryLen:0,baseHistoryLen:null};let i=0;while(i<text.length){let ch=text[i];if(/\s/.test(ch)){while(i<text.length&&/\s/.test(text[i]))i++;this.ensure(ctx,ctx.type==="main"?"pgn-mainline":"pgn-variation");appendText(ctx.container," ");continue}if(ch==="("){i++;let fen=ctx.prevFen||ctx.chess.fen();let hist=typeof ctx.prevHistoryLen==="number"?ctx.prevHistoryLen:ctx.chess.history().length;ctx={type:"variation",chess:new Chess(fen),container:null,parent:ctx,lastWasInterrupt:true,prevFen:fen,prevHistoryLen:hist,baseHistoryLen:hist};this.ensure(ctx,"pgn-variation");continue}if(ch===")"){i++;if(ctx.parent){ctx=ctx.parent;ctx.lastWasInterrupt=true;ctx.container=null}continue}if(ch==="{"){i=this.parseComment(text,i+1,ctx);continue}let start=i;while(i<text.length&&!/\s/.test(text[i])&&! "(){ }".includes(text[i]))i++;let tok=text.substring(start,i);if(!tok)continue;if(tok==="[D]"){createDiagram(this.wrapper,ctx.chess.fen());ctx.lastWasInterrupt=true;ctx.container=null;continue}if(RESULT_REGEX.test(tok)){this.ensure(ctx,ctx.type==="main"?"pgn-mainline":"pgn-variation");appendText(ctx.container,tok+" ");continue}if(MOVE_NUMBER_REGEX.test(tok))continue;let stripped=tok.replace(/[^a-hKQRBN0-9=O0-]+$/g,"").replace(/0/g,"O");let isSAN=PGNGameView.isSANCore(stripped);if(!isSAN){let letters=/[A-Za-zÇĞİÖŞÜçğıöşü]/.test(tok);if(EVAL_TOKEN.test(tok)&&tok===this.lastLiteralToken)continue;if(letters){if(ctx.type==="variation"){this.ensure(ctx,"pgn-variation");appendText(ctx.container," "+tok)}else{let P=document.createElement("p");P.className="pgn-comment";appendText(P,tok);this.wrapper.appendChild(P);ctx.container=null;ctx.lastWasInterrupt=true}}else{this.ensure(ctx,ctx.type==="main"?"pgn-mainline":"pgn-variation");appendText(ctx.container,tok+" ")}this.lastLiteralToken=tok;this.lastWasMove=false;continue}this.ensure(ctx,ctx.type==="main"?"pgn-mainline":"pgn-variation");let sn=this.handleSAN(tok,ctx);if(!sn)appendText(ctx.container,tok+" ")}}applyFigurines(){let map={K:"♔",Q:"♕",R:"♖",B:"♗",N:"♘"};this.wrapper.querySelectorAll(".pgn-move").forEach(s=>{let m=s.textContent.match(/^([KQRBN])(.+?)(\s*)$/);if(m)s.textContent=map[m[1]]+m[2]+(m[3]||"")})}}
class PGNRenderer{static renderAll(root){(root||document).querySelectorAll("pgn").forEach(el=>new PGNGameView(el))}static init(){if(!ensureDeps())return;PGNRenderer.renderAll(document);window.PGNRenderer={run(r){PGNRenderer.renderAll(r||document.body)}}}}
if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>PGNRenderer.init());else PGNRenderer.init();
})();
