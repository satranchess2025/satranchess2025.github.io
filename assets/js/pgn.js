(function(){"use strict";const W="https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",S=/^(O-O(-O)?[+#]?|[KQRBN]?[a-h]?[1-8]?x?[a-h][1-8](=[QRBN])?[+#]?|[a-h][1-8](=[QRBN])?[+#]?)$/,R=/^(1-0|0-1|1\/2-1\/2|½-½|\*)$/,N=/^(\d+)(\.+)$/;let g=0;function y(){if(typeof Chess=="undefined"){console.warn("pgn.js: chess.js missing");return!1}return!0}function L(e){return e?e.replace(/1\/2-1\/2/g,"½-½"):""}function E(e){if(!e)return"";let t=e.split(".");return/^\d{4}$/.test(t[0])?t[0]:""}function T(e){if(!e)return"";let t=e.indexOf(",");return t===-1?e.trim():e.substring(t+1).trim()+" "+e.substring(0,t).trim()}function a(e,t){t&&e.appendChild(document.createTextNode(t))}function D(e,t){if(typeof Chessboard=="undefined"){console.warn("pgn.js: chessboard.js missing for diagrams");return}let r="pgn-diagram-"+g++,n=document.createElement("div");n.className="pgn-diagram",n.id=r,n.style.width="340px",n.style.maxWidth="100%";e.appendChild(n);setTimeout(()=>{let i=document.getElementById(r);i&&Chessboard(i,{position:t,draggable:!1,pieceTheme:W})},0)}class x{constructor(t){this.sourceEl=t,this.wrapper=document.createElement("div"),this.wrapper.className="pgn-blog-block",this.buildFromElement(),this.fig()}static s(e){return S.test(e)}static h(e){let t=e.split(/\r?\n/),r=[],n=[],i=!0;for(let o of t){let s=o.trim();i&&s.startsWith("[")&&s.endsWith("]")?r.push(o):i&&s==""?i=!1:(i=!1,n.push(o))}return{headerLines:r,movetext:n.join(" ").replace(/\s+/g," ").trim()}}buildFromElement(){let e=this.sourceEl.textContent.trim(),{headerLines:t,movetext:r}=x.h(e),n=(t.length?t.join("\n")+"\n\n":"")+r,i=new Chess;i.load_pgn(n,{sloppy:!0});let o=i.header(),s=L(o.Result||"");this.header(o),this.dom(r+(s?" "+s:"")),this.sourceEl.replaceWith(this.wrapper)}header(e){let t=(e.WhiteTitle?e.WhiteTitle+" ":"")+T(e.White||"")+(e.WhiteElo?" ("+e.WhiteElo+")":""),r=(e.BlackTitle?e.BlackTitle+" ":"")+T(e.Black||"")+(e.BlackElo?" ("+e.BlackElo+")":""),n=E(e.Date),i=(e.Event||"")+(n?", "+n:""),o=document.createElement("h3");o.appendChild(document.createTextNode(t+" – "+r)),o.appendChild(document.createElement("br")),o.appendChild(document.createTextNode(i)),this.wrapper.appendChild(o)}p(e,t){if(!t.container){let r=document.createElement("p");r.className=e,this.wrapper.appendChild(r),t.container=r}}m(e,t){let r=e.replace(/[^a-hKQRBN0-9=]+$/g,"");if(!x.s(r))return null;if(t.type==="variation"){if(t.pendingNumber!=null){let f=t.pendingDots===3?"... ":". ";a(t.container,t.pendingNumber+f),t.pendingNumber=null,t.pendingDots=null}}else{let f=t.chess.history().length,u=f%2==0,h=Math.floor(f/2)+1;u?(a(t.container,h+". "),t.lastWasInterrupt=!1):(t.lastWasInterrupt&&a(t.container,h+"... "),t.lastWasInterrupt=!1)}let n=t.chess.move(r,{sloppy:!0});if(!n)return a(t.container,e+" "),null;let i=document.createElement("span");return i.className="pgn-move sticky-move",i.dataset.fen=t.chess.fen(),i.textContent=e+" ",t.container.appendChild(i),i}c(e,t,r){let n=e.length,i=t;for(;i<n&&e[i]!="}";)i++;let o=e.substring(t,i);e[i]=="}"&&i++;let s=o.split(/\s+/).filter(Boolean),d=!1;for(let p=0;p<s.length;p++){let v=s[p].replace(/[^a-hKQRBN0-9=]+$/g,"");if(x.s(v)){d=!0;break}}if(!d){this.p(r.type==="main"?"pgn-mainline":"pgn-variation",r);let p=o.split("[D]");for(let v=0;v<p.length;v++){let h=p[v].trim();h&&a(r.container," "+h),v<p.length-1&&D(this.wrapper,r.chess.fen())}return i}let l=new Chess(r.chess.fen()),c=document.createElement("p");c.className="pgn-comment",this.wrapper.appendChild(c);let u=0,h=o.length;for(;u<h;){let p=o[u];if(/\s/.test(p)){for(;u<h&&/\s/.test(o[u]);)u++;a(c," ");continue}let v=u;for(;u<h&&!/\s/.test(o[u]);)u++;let k=o.substring(v,u);if(!k)continue;if(k=="[D]"){D(this.wrapper,l.fen());c=document.createElement("p"),c.className="pgn-comment",this.wrapper.appendChild(c);continue}let m=k.replace(/[^a-hKQRBN0-9=]+$/g,"");if(!x.s(m)){a(c,k+" ");continue}let b=l.move(m,{sloppy:!0});if(!b){a(c,k+" ");continue}let y=document.createElement("span");y.className="pgn-move sticky-move",y.dataset.fen=l.fen(),y.textContent=k+" ",c.appendChild(y)}return r.lastWasInterrupt=!0,r.container=null,i}dom(e){let t=new Chess,r={type:"main",chess:t,container:null,parent:null,lastWasInterrupt:!1,pendingNumber:null,pendingDots:null},n=r,i=0,o=e.length;for(;i<o;){let s=e[i];if(/\s/.test(s)){for(;i<o&&/\s/.test(e[i]);)i++;this.p(n.type==="main"?"pgn-mainline":"pgn-variation",n),a(n.container," ");continue}if(s=="("){i++,n.lastWasInterrupt=!0;let l=new Chess(n.chess.fen());n={type:"variation",chess:l,container:null,parent:n,lastWasInterrupt:!1,pendingNumber:null,pendingDots:null},this.p("pgn-variation",n);continue}if(s==")"){i++,n.parent&&(n=n.parent,n.lastWasInterrupt=!0,n.container=null);continue}if(s=="{"){i=this.c(e,i+1,n);continue}let d=i;for(;i<o&&!/\s|\(|\)|\{|\}/.test(e[i]);)i++;let l=e.substring(d,i);if(!l)continue;if(l=="[D]"){D(this.wrapper,n.chess.fen()),n.lastWasInterrupt=!0,n.container=null;continue}if(R.test(l)){this.p(n.type==="main"?"pgn-mainline":"pgn-variation",n),a(n.container,l+" ");continue}let c=l.match(N);if(c){n.pendingNumber=parseInt(c[1],10),n.pendingDots=c[2].length;continue}this.p(n.type==="main"?"pgn-mainline":"pgn-variation",n);let u=this.m(l,n);u||a(n.container,l+" ")}}fig(){if(window.ChessFigurine&&typeof window.ChessFigurine.run=="function"){window.ChessFigurine.run(this.wrapper);return}let e={K:"♔",Q:"♕",R:"♖",B:"♗",N:"♘"};this.wrapper.querySelectorAll(".pgn-move").forEach(t=>{let r=t.textContent.match(/^([KQRBN])(.+?)(\s*)$/);if(!r)return;let n=e[r[1]];n&&(t.textContent=n+r[2]+(r[3]||""))})}}class F{static run(t){(t||document).querySelectorAll("pgn").forEach(r=>new x(r))}static init(){y()&&F.run(document),window.PGNRenderer={run(t){F.run(t||document.body)}}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>F.init()):F.init();})();
