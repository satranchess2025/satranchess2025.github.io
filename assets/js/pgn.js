(function(){"use strict";const T="https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",C=/^(O-O(-O)?[+#]?|[KQRBN]?[a-h]?[1-8]?x?[a-h][1-8](=[QRBN])?[+#]?|[a-h][1-8](=[QRBN])?[+#]?)$/,R=/^(1-0|0-1|1\/2-1\/2|½-½|\*)$/,M=/^\d+\.+$/;let g=0;function y(){if(typeof Chess=="undefined"){console.warn("pgn.js: chess.js missing");return!1}return!0}function L(e){return e?e.replace(/1\/2-1\/2/g,"½-½"):""}function E(e){if(!e)return"";let t=e.split(".");return/^\d{4}$/.test(t[0])?t[0]:""}function N(e){if(!e)return"";let t=e.indexOf(",");return t===-1?e.trim():e.substring(t+1).trim()+" "+e.substring(0,t).trim()}function a(e,t){t&&e.appendChild(document.createTextNode(t))}function D(e,t){if(typeof Chessboard=="undefined"){console.warn("pgn.js: chessboard.js missing for diagrams");return}let r="pgn-diagram-"+g++,n=document.createElement("div");n.className="pgn-diagram";n.id=r;n.style.width="340px";n.style.maxWidth="100%";e.appendChild(n);setTimeout(()=>{let i=document.getElementById(r);i&&Chessboard(i,{position:t,draggable:!1,pieceTheme:T})},0)}class w{constructor(t){this.sourceEl=t,this.wrapper=document.createElement("div"),this.wrapper.className="pgn-blog-block",this.board=null,this.activeMoveSpan=null,this.buildFromElement(),this.attachClick(),this.fig()}static s(e){return C.test(e)}static h(e){let t=e.split(/\r?\n/),r=[],n=[],i=!0;for(let o of t){let s=o.trim();i&&s.startsWith("[")&&s.endsWith("]")?r.push(o):i&&s==""?i=!1:(i=!1,n.push(o))}return{headerLines:r,movetext:n.join(" ").replace(/\s+/g," ").trim()}}buildFromElement(){let e=this.sourceEl.textContent.trim(),{headerLines:t,movetext:r}=w.h(e),n=(t.length?t.join("\n")+"\n\n":"")+r,i=new Chess;i.load_pgn(n,{sloppy:!0});let o=i.header(),s=L(o.Result||"");this.header(o),this.mainBoard(),this.dom(r+(s?" "+s:"")),this.sourceEl.replaceWith(this.wrapper)}header(e){let t=(e.WhiteTitle?e.WhiteTitle+" ":"")+N(e.White||"")+(e.WhiteElo?" ("+e.WhiteElo+")":""),r=(e.BlackTitle?e.BlackTitle+" ":"")+N(e.Black||"")+(e.BlackElo?" ("+e.BlackElo+")":""),n=E(e.Date),i=(e.Event||"")+(n?", "+n:""),o=document.createElement("h3");o.appendChild(document.createTextNode(t+" – "+r)),o.appendChild(document.createElement("br")),o.appendChild(document.createTextNode(i)),this.wrapper.appendChild(o)}mainBoard(){if(typeof Chessboard=="undefined")return;let e=document.createElement("div");e.className="pgn-main-board pgn-diagram",e.style.width="340px",e.style.maxWidth="100%";let t=this.wrapper.querySelector("h3");t&&t.nextSibling?this.wrapper.insertBefore(e,t.nextSibling):this.wrapper.appendChild(e),this.board=Chessboard(e,{position:"start",draggable:!1,pieceTheme:T,moveSpeed:200,snapSpeed:100,snapbackSpeed:100})}p(e,t){if(!t.container){let r=document.createElement("p");r.className=e;this.wrapper.appendChild(r),t.container=r}}m(e,t){let r=e.replace(/[!?+#]+$/g,"");if(!w.s(r))return null;let n=t.chess.history().length,i=n%2==0,o=Math.floor(n/2)+1;i?(a(t.container,o+". "),t.lastWasInterrupt=!1):(t.lastWasInterrupt&&a(t.container,o+"... "),t.lastWasInterrupt=!1);let s=t.chess.move(r,{sloppy:!0});if(!s)return a(t.container,e+" "),null;let d=document.createElement("span");return d.className="pgn-move sticky-move",d.dataset.fen=t.chess.fen(),d.textContent=e+" ",t.container.appendChild(d),d}c(e,t,r){let n=e.length,i=t;for(;i<n&&e[i]!="}";)i++;let o=e.substring(t,i);e[i]=="}"&&i++;let s=o.split(/\s+/).filter(Boolean),d=!1;for(let f=0;f<s.length;f++){let u=s[f].replace(/[!?+#]+$/g,"");if(w.s(u)){d=!0;break}}if(!d){this.p(r.type==="main"?"pgn-mainline":"pgn-variation",r);let f=o.split("[D]");for(let u=0;u<f.length;u++){let h=f[u].trim();h&&a(r.container," "+h),u<f.length-1&&D(this.wrapper,r.chess.fen())}return i}let l=new Chess(r.chess.fen()),p=document.createElement("p");p.className="pgn-comment",this.wrapper.appendChild(p);let v=0,S=o.length;for(;v<S;){let f=o[v];if(/\s/.test(f)){for(;v<S&&/\s/.test(o[v]);)v++;a(p," ");continue}let u=v;for(;v<S&&!/\s/.test(o[v]);)v++;let h=o.substring(u,v);if(!h)continue;if(h=="[D]"){D(this.wrapper,l.fen());p=document.createElement("p"),p.className="pgn-comment",this.wrapper.appendChild(p);continue}let k=h.replace(/[!?+#]+$/g,"");if(!w.s(k)){a(p,h+" ");continue}let m=l.move(k,{sloppy:!0});if(!m){a(p,h+" ");continue}let x=document.createElement("span");x.className="pgn-move sticky-move",x.dataset.fen=l.fen(),x.textContent=h+" ",p.appendChild(x)}return r.lastWasInterrupt=!0,r.container=null,i}dom(e){let t=new Chess,r={type:"main",chess:t,container:null,parent:null,lastWasInterrupt:!1},n=r,i=0,o=e.length;for(;i<o;){let s=e[i];if(/\s/.test(s)){for(;i<o&&/\s/.test(e[i]);)i++;this.p(n.type==="main"?"pgn-mainline":"pgn-variation",n),a(n.container," ");continue}if(s=="("){i++,n.lastWasInterrupt=!0;let l=new Chess(n.chess.fen());n={type:"variation",chess:l,container:null,parent:n,lastWasInterrupt:!1},this.p("pgn-variation",n);continue}if(s==")"){i++,n.parent&&(n=n.parent,n.lastWasInterrupt=!0,n.container=null);continue}if(s=="{"){i=this.c(e,i+1,n);continue}let d=i;for(;i<o&&!/\s|\(|\)|\{|\}/.test(e[i]);)i++;let l=e.substring(d,i);if(!l)continue;if(l=="[D]"){D(this.wrapper,n.chess.fen()),n.lastWasInterrupt=!0,n.container=null;continue}if(R.test(l)){this.p(n.type==="main"?"pgn-mainline":"pgn-variation",n),a(n.container,l+" ");continue}if(M.test(l))continue;this.p(n.type==="main"?"pgn-mainline":"pgn-variation",n);let p=this.m(l,n);p||a(n.container,l+" ")}}b(e,t){this.board&&(this.board.position(e,!0),this.activeMoveSpan&&this.activeMoveSpan.classList.remove("pgn-move--active"),t&&(t.classList.add("pgn-move--active"),this.activeMoveSpan=t))}attachClick(){this.wrapper.addEventListener("click",e=>{let t=e.target.closest(".pgn-move");if(!t||!this.wrapper.contains(t))return;let r=t.dataset.fen;r&&this.b(r,t)})}fig(){if(window.ChessFigurine&&typeof window.ChessFigurine.run=="function"){window.ChessFigurine.run(this.wrapper);return}let e={K:"♔",Q:"♕",R:"♖",B:"♗",N:"♘"};this.wrapper.querySelectorAll(".pgn-move").forEach(t=>{let r=t.textContent.match(/^([KQRBN])(.+?)(\s*)$/);if(!r)return;let n=e[r[1]];n&&(t.textContent=n+r[2]+(r[3]||""))})}}class F{static run(t){(t||document).querySelectorAll("pgn").forEach(r=>new w(r))}static init(){y()&&F.run(document)}}
document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>F.init()):F.init();
})();
